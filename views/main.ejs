<!DOCTYPE html>
<html>

<head>
  <title>Speak.js</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 3rem;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    #form {
      background: rgba(0, 0, 0, 0.15);
      padding: 0.25rem;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      height: 3rem;
      box-sizing: border-box;
      backdrop-filter: blur(10px);
    }

    #input {
      border: none;
      padding: 0 1rem;
      flex-grow: 1;
      border-radius: 2rem;
      margin: 0.25rem;
    }

    #input:focus {
      outline: none;
    }

    #form>button {
      background: #333;
      border: none;
      padding: 0 1rem;
      margin: 0.25rem;
      border-radius: 3px;
      outline: none;
      color: #fff;
    }

    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    #messages>li {
      padding: 0.5rem 1rem;
    }

    #messages>li:nth-child(odd) {
      background: #efefef;
    }
  </style>
</head>

<body>
  <ul id="messages"></ul>
  <form id="form" action="">
    <input id="input" autocomplete="off" /><button>Send</button>
  </form>
</body>
<script>
  var server = 'speakjs.herokuapp.com',
    socket = null
  try {
    socket = new WebSocket('ws://' + server)
  } catch (e) {
    new Error(e)
  }
  socket.onerror = function (e) {
    new Error(e)
  }
  socket.onclose = function (e) {
    console.log('connexion terminé.')
  }
  socket.onopen = function (e) {
    console.log('connexion établie avec succes')

    function getmsg() {
      JSON.parse('<%-data.msg%>').slice(Number('<%=data.number%>') < 20 ? 0 : -20).forEach(a => {
        var item = document.createElement('li')
        item.textContent = `${a.username}  ${a.CreatedAt}:\n${a.content}`
        messages.appendChild(item)
        window.scrollTo(0, document.body.scrollHeight)
      })
    }
    getmsg()

    socket.onmessage = function (m) {
      let e = JSON.parse(m.data)
      var request = new Request('/decrypte', {
        method: 'POST',
        body: JSON.stringify({
          'key': e.expire,
          'chaine': e.content
        }),
        headers: new Headers({
          'Content-Type': 'application/json'
        })
      })
      fetch(request).then(resp => resp.json().then(r => {
        var item = document.createElement('li')
        item.textContent = `${e.username}  ${e.date}:\n${r.content}`
        messages.appendChild(item)
        window.scrollTo(0, document.body.scrollHeight)
      })).catch(err => console.error(err))
    }

    var input = document.getElementById('input')

    document.getElementById('form').addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        let ch = Date.now() + 1800000 / 2.3 * 5.5
        var request = new Request('/crypte', {
          method: 'POST',
          body: JSON.stringify({
            'key': String(ch),
            'chaine': input.value
          }),
          headers: new Headers({
            'Content-Type': 'application/json'
          })
        })
        fetch(request).then(resp => resp.json().then(r => {
          socket.send(JSON.stringify({
            username: "punchnox client web",
            content: r.content,
            event: 'msg',
            expire: ch
          }))
        })).catch(err => console.error(err))
        input.value = ''
      }
    })

  }
</script>

</html>